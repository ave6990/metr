<html> <head>
    <title>Расчет ГС-2000 v2.0.0</title>
    <meta name="viewport" content="width=device-width" charset="utf-8">
    <style type="text/css">
        html {
            background: #ddd;
            height: 100%;
        }

        body {
            margin: 0px;
            color: #222;
            background: #fcfcfc;
            font: 12pt sans-serif;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        main {
            margin: 10px;
            flex-grow: 1;
        }

        section {
            margin: 5px;
        }

        section header {
            font-size: 12pt;
            border-radius: 10px;
        }

        footer, header {
            font-size: 18px;
            padding: 6px;
            background: #034769;
            color: #fafafa;
        }

        footer {
            text-align: center;
            flex-shrink: 0;
        }

        label {
            display: block;
        }

        input, select, button {
            margin: 5px;
            font-size: 12pt;
            border-color: #086fa1;
            border-style: solid;
            border-width: 1px;
            border-radius: 5px;
        }

        button {
            color: #222;
        }

        #valves {
            margin: 10px 0;
            display: flex;
            flex-direction: row;
            flex-wrap: nowrap;
        }

        #valves label {
            margin: 0;
            width: 30px;
            text-align: center;
        }

        .toggle_button {
            margin: 0;
            height: 60px;
            width: 30px;
            vertical-align: center;
            background: #fff;
            border: 1px solid #086fa1;
            border-radius: 15px;
            outline: none;
            position: relative;
            display: inline-block;
            appearance: none;
            -moz-appearance: none;
        }

        .toggle_button::after {
            content: "";
            display: inline-block;
            position: absolute;
            left: 1px;
            top: 2px;
            width: 26px;
            height: 26px;
            background-color: gray;
            border-radius: 50%;
            transform: translateY(0);
        }

        .toggle_button:checked::after {
            transform: translateY(calc(100% + 2px));
            background-color: red;
        }

        .valves {
            flex: 1 1 auto;
            max-width: 50px;
        }

        .warning {
            background-color: yellow;
        }
    </style>
</head>
<body>
    <header>
        <p>Расчет режимов работы генератора ГС-2000 зав. № 58-2-21</p>
    </header>
    <main>
        <section id=input_date>
            <header>Исходные данные</header>
            <main>
                <div >
                    <label for=diluent>Целевой компонент:</label>
                    <select id=component>
                        <option value="none" default>не выбран</option>
                    </select>
                </div>
                <div>
                    <label for=diluent>Газ-разбавитель:</label>
                    <select id=diluent>
                        <option value="air">воздух</option>
                        <option value="n2">азот</option>
                    </select>
                </div>
                <div>
                    <label for=source_conc>Концентрация исходной ГС:</label>
                    <input type=text id=source_conc pattern='\d+[\.]?\d*'>
                    <select id="source_unit" >
                        <option value="ppm">ppm</option>
                        <option value="%">%</option>
                    </select>
                </div>
                <div>
                    <label for=target_conc>Требуемая концентрация ГС на выходе:</label>
                    <input type=text id=target_conc pattern='\d+[\.]?\d*'>
                    <select id="target_unit" >
                        <option value="ppm">ppm</option>
                        <option value="%">%</option>
                        <option value="mg/m^3">mg/m^3</option>
                    </select>
                </div>
                <button id=btn_calc>Расчитать</button>
            </main>
        </section>
        <section id=result>
            <header>Результаты</header>
            <main>
                <label for="valve_number">Положение переключателей:</label>
                <div id=valves>
                    <div class=valves>
                        <label for="v1">1</label>
                        <input type="checkbox" id="v1" class="toggle_button">
                    </div>
                    <div class=valves>
                        <label for="v2">2</label>
                        <input type="checkbox" id="v2" class="toggle_button">
                    </div>
                    <div class=valves>
                        <label for="v3">3</label>
                        <input type="checkbox" id="v3" class="toggle_button">
                    </div>
                    <div class=valves>
                        <label for="v4">4</label>
                        <input type="checkbox" id="v4" class="toggle_button">
                    </div>
                    <div class=valves>
                        <label for="v5">5</label>
                        <input type="checkbox" id="v5" class="toggle_button">
                    </div>
                    <div class=valves>
                        <label for="v6">6</label>
                        <input type="checkbox" id="v6" class="toggle_button">
                    </div>
                    <div class=valves>
                        <label for="v7">7</label>
                        <input type="checkbox" id="v7" class="toggle_button">
                    </div>
                    <div class=valves>
                        <label for="v8">8</label>
                        <input type="checkbox" id="v8" class="toggle_button">
                    </div>
                    <div class=valves>
                        <label for="v9">9</label>
                        <input type="checkbox" id="v9" class="toggle_button">
                    </div>
                    <div class=valves>
                        <label for="v10">10</label>
                        <input type="checkbox" id="v10" class="toggle_button">
                    </div>
                </div>
                <div>
                    <label for="result_conc">Расчетная концентрация ГС на выходе:</label>
                    <input type="text" id="result_conc" disabled>
                </div>
             </main>     
        </section>
        <section id="info">
        </section>
    </main>
    <footer>
        <p>Ермолаев Александр Викторович ©</p>
    </footer>
</body>

<script>
/* Коэффициенты разбавления (паспортные значения) */
const coefficients = {'air': [1176, 513, 253, 134, 70.4, 46.8, 36.3, 24.3, 14, 10.5],
    'n2': [1196, 522, 267, 136, 71.6, 47.6, 36.9, 24.7, 14.2, 10.7],
}

const molar_mass = {
    N2: 28.016, NH3: 17.031, Ar: 39.944, C2H2: 26.04,
    C3H6O: 58.08, C4H10: 58.12, C4H9OH: 74.12, H2O: 18.016,
    H2: 2.0156, air: 28.96, C6H14: 86.17, He: 4.003,
    C7H16: 100.19, CO2: 44.01, C10H22: 142.30, C12H10: 154.08,
    C12H10O: 168.8, CH2Cl2: 84.94, C4H10O: 74.12, N2O: 44.016,
    HJ: 127.93, O2: 32, Kr: 83.7, Xe: 131.3, CH4: 16.04,
    CH5N: 31.06, CH3OH: 32.04, Ne: 20.183, NOCl: 65.465,
    O3: 48.00, NO: 30.008, CO: 28.01, C8H18: 114.22,
    C5H12: 72.14, C3H8: 44.09, C3H6: 42.08, H2Se: 80.968,
    SO2: 64.06, SO3: 80.06, H2S: 34.08, PH3: 34.04,
    CF3Cl: 137.40, CF2Cl2: 120.92, CFCl3: 114.47, F2: 38,
    SiF4: 104.06, CH3F: 34.03, Cl2: 70.914, HCl: 36.465,
    CH3Cl: 50.49, CHCl3: 119.39, C2N2: 52.04, HCN: 27.026,
    C2H6: 30.07, C2H7N: 45.08, C2H4: 28.05, C2H5OH: 46.069,
    C2H5Cl: 64.52, CH3SH: 48.11, CS2: 76.1407, CH3OCH3: 46.069,
    C2H4O: 44.053,
}

const molar_volume = {
    'air': 24.06,
    'n2': 24.04,
}

const components = ['NO', 'NO2', 'N2O', 'NH3', 'H2', 'H2S', 'SO2', 
    'O2', 'CO', 'CO2', 'CS2', 'CH4', 'C2H6', 'C3H8', 'C4H10',
    'C5H12', 'C6H14', 'CH3OH', 'CH3SH', 'CH3OCH3', 'C2H5OH',
    'C2H4O']

const lel = {C3H8: 17000, C3H6: 20000, C4H10: 13000, C5H12: 15000, C6H14: 10000,
    C6H6: 12000, C2H4: 23000, C2H2: 23000, C2H6: 25000, H2: 40000, H2S: 40000}

const get_valves = () => {
    let valves = []

    for (let i = 1; i <= 10; i++) {
        valves.push(document.getElementById(`v${i}`))
    }
    return valves
}

/* Массив переключателей клапанов */
const valves = get_valves()

valves.forEach( (valve) => {
    valve.addEventListener("change", (event) => {
        const states = read_valves_states()
        const in_data = readData()
        const out_data = reCalculate({coeff: in_data.coeff, 
            source_conc: in_data.source_conc, 
            valves: states,
        })
        out_data.target_unit = in_data.target_unit
        out_data.diluent = in_data.diluent
        out_data.component = in_data.component
        out_data.conc += h2sCorrection(out_data)
        displayResults(out_data)
    })
})

const calculate = ({ coeff, source_conc, target_conc }) => {
    let temp_coeff = [...coeff]
    let variants = {}
    let res = 0
    let k_list = []

    checkInData({ source_conc })

    while (temp_coeff.length > 0) {
        const target_k = source_conc / (target_conc - res)
        temp_coeff = spliceList(target_k, temp_coeff)

        const k = temp_coeff.pop()
        const temp_res = source_conc / calcCoefficient([k, ...k_list])

        if (sortFunc(target_conc)(res, temp_res) > 0 || res == 0) {
            if (temp_res > target_conc) {
                variants[temp_res] = [k, ...k_list]
            } else {
                k_list.push(k)
                res = temp_res
            }
        }
    }

    if (k_list.length > 0) {
        variants[res] = [...k_list]
    }

    const results = Object.keys(variants).map((val) => parseFloat(val))
    res = results.sort(sortFunc(target_conc))[0]
    k_list = variants[res]

    const index_list = k_list.map( (val) => {
        return coeff.indexOf(val) + 1
    } )

    return {conc: res, valves: index_list, }
}

const checkInData = ({source_conc}) => {
    if (source_conc > 20000) {
        throw new GS2000Error('Содержание целевого компонента в исходной ГС не должно превышать 2 % (20000 ppm)!')
    }

    if (source_conc < 0) {
        throw new GS2000Error('Содержание целевого компонента должно быть выражено положительным числом!')
    }
    
}

/* Расчет коэффициента разбавления, при включении
нескольких клапанов. */
const calcCoefficient = (list) => {
    const divider = list.map( (val) => {
        return 1 / (val -1)
    } )
    .reduce( (a, b) => {
        return a + b
    } )

    return 1 / divider + 1
}

/* Функция сравнения чисел по признаку их близости к некоторому заданному значению. */
const sortFunc = (value) => {
    return (a, b) => {
        if (Math.abs(a - value) > Math.abs(b - value)) {
            return 1
        }
        if (Math.abs(a - value) < Math.abs(b - value)) {
            return -1
        }
        else {
            return 0
        }
    }
}

/* Удаляет из списка значения меньшие заданного. */
const spliceList = (value, list) => {
    let temp_list = [...list]

    const [first, second] = temp_list.sort(sortFunc(value))
    const index = list.indexOf(Math.min(first, second))

    if (index >= 0) {
        temp_list = [...list]
        temp_list.splice(index + 1)
    }

    return temp_list
}

/* Обратный расчет - концентрация расчитывается по номерам клапанов. */
const reCalculate = ( {coeff, source_conc, valves} ) => {
    checkInData({source_conc})

    const k_list = valves.map( (val) => {
        return coeff[val - 1]
    } )

    if (k_list.length < 1) {
        return { conc: 0, valves: [] }
    }

    return { conc: source_conc / calcCoefficient(k_list),
        valves: valves,
    }
}

const h2sCorrection = ({conc, component}) => {
    if (component = 'H2S' && conc >= 0.005 && conc <= 0.01) {
        console.info(`H2S correction:\n\t${conc} + 0.00025`)
        return 0.00025
    }
    return 0
}

const readSourceConc = () => {
    warning(' ')
    const source_unit = document.getElementById('source_unit').value
    let source_conc = parseFloat(document.getElementById('source_conc').value.replace(',', '.'))
    const component = document.getElementById('component').value
    let k = 1

    if (source_unit == '%') {
        k = 10000
    }

    source_conc *= k

    if (source_conc > 20000) {
        warning('Содержание целевого компонента в исходной смеси не должно превышать 2 % об. (20000 млн<sup>-1</sup>)!')
        source_conc = 20000
    }

    if (lel[component]) {
        const lel05 = lel[component] / 2
        if (source_conc > lel05) {
            warning(`Содержание целевого компонента в исходной ГС не должно превышать 50 % НКПР (${component} - ${res_round(lel05 / 10000)} % об.)!`)
            source_conc = lel05
        }
    }

    document.getElementById('source_conc').value = source_conc / k
    
    return source_conc
}

const readTargetConc = () => {
    warning(' ')
    const source_conc = readSourceConc()
    let target_unit = document.getElementById('target_unit').value
    const diluent = document.getElementById('diluent').value
    const component = document.getElementById('component').value
    let target_conc = parseFloat(document.getElementById('target_conc').value.replace(',', '.'))
    let k = 1

    console.info('********Calculate*********')
    console.info(`Заданная концентрация:\n\t${target_conc} ${target_unit}`)
    if (target_unit == '%') {
        k = 10000
    } else if (target_unit == 'mg/m^3') {
        if (component == 'none') {
            warning('Для пересчета концентрации в мг/м<sup>3</sup> необходимо выбрать целевой компонент!')
            target_unit = 'ppm'
            document.getElementById('target_unit').value = target_unit
        } else {
            k = molar_volume[diluent] / molar_mass[component]
        }
    }

    target_conc *= k

    const max_conc = res_round(source_conc / calcCoefficient(coefficients[diluent]))
    const min_conc = res_round(source_conc / coefficients[diluent][0])
    if (target_conc > max_conc) {
        target_conc = max_conc
        warning(`Концентрация ГС на выходе не может быть больше ${target_conc} ${target_unit}!`)
    }
    if (target_conc < min_conc) {
        target_conc = min_conc
        warning(`Концентрация ГС на выходе не может быть меньше ${target_conc} ${target_unit}!`)
    }

    document.getElementById('target_conc').value = res_round(target_conc / k)
    console.info(`\t${target_conc} ppm`)

    return target_conc
}

document.getElementById('source_conc').addEventListener('change', readSourceConc)
document.getElementById('source_unit').addEventListener('change', readSourceConc)
document.getElementById('target_conc').addEventListener('change', readTargetConc)
document.getElementById('target_unit').addEventListener('change', readTargetConc)

components.forEach( (c) => {
    let option = document.createElement('option')
    option.value = c
    option.text = c
    document.getElementById('component').append(option)
} )

/* Округление результата (~ на 2 порядка точнее погрешности генератора) */
const res_round = (val) => {
    if (val == 0) {
        return 0
    }
    
    let exp = Math.log10(val)
    
    if (exp > 0) {
        exp = Math.ceil(exp)
    } else {
        exp = Math.floor(exp)
    }

    if (exp < 0) {
        exp = exp - 3
    } else {
        exp = exp - 5
    }

    if (exp < 0) {
        return Math.round(val * (10 ** Math.abs(exp))) / (10 ** Math.abs(exp))
    }

    return Math.round(val)
}

const readData = () => {
    warning(' ')
    const diluent = document.getElementById('diluent').value
    const source_unit = document.getElementById('source_unit').value
    let target_unit = document.getElementById('target_unit').value
    const component = document.getElementById('component').value
    let source_conc = readSourceConc()
    let target_conc = readTargetConc()

    return {
        component: component,
        diluent: diluent,
        coeff: coefficients[diluent],
        source_conc: source_conc,
        source_unit: source_unit,
        target_conc: target_conc,
        target_unit: target_unit,
    }
}

document.getElementById('btn_calc').addEventListener('click', (event) => {
    clear_valves()
    const in_data = readData()
    const out_data = calculate(in_data)
    out_data.target_unit = in_data.target_unit
    out_data.diluent = in_data.diluent
    out_data.component = in_data.component
    out_data.conc += h2sCorrection(out_data)

    displayResults(out_data)
} )

const warning = (message) => {
    document.getElementById('info').innerHTML = `<p class="warning">${message}</p>`
}

const displayResults = (data) => {
    console.info(`Расчетная концентрация:\n\t${data.conc} ppm`)
    if (data.target_unit == '%') {
        data.conc = data.conc / 10000
    } else if (data.target_unit == 'mg/m^3') {
        data.conc = data.conc * molar_mass[data.component] / molar_volume[data.diluent]
    }
    console.info(`\t${data.conc} ${data.target_unit}\n\n`)
    document.getElementById('result_conc').value = `${res_round(data.conc)} ${data.target_unit}`
    data.valves.forEach( (valve) => {
        valves[valve - 1].checked = true
    } )
}

const clear_valves = () => {
    valves.forEach( (valve) => {
        valve.checked = false
    })
}

const read_valves_states = () => {
    const active_valves = valves.map( (valve, i) => {
        if (valve.checked == true) {
            return i + 1
        }
    })
    return active_valves.filter( (val) => {
        if (val) {
            return val
        }
    } )
}
</script>
</html>
